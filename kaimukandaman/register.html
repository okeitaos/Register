<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πà‡∏á | Running Registration</title>
<style>
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a); 
    color:#fff; margin:0; padding:20px; min-height:100vh;
    display:flex; justify-content:center; align-items:center;
  }
  form.container {
    position: relative; width:100%; max-width:500px;
    background: rgba(255,255,255,0.05); border-radius:25px; padding:35px 25px 50px 25px;
    backdrop-filter: blur(20px); box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    border:1px solid rgba(255,255,255,0.15); text-align:left;
  }
  .logo { display:block; margin:0 auto 15px auto; width:80px; height:80px; }
  h1 { text-align:center; font-size:1.9rem; color:#facc15; margin-bottom:5px; text-shadow: 0 0 15px rgba(250, 204, 21,0.7); }
  h2 { text-align:center; font-size:1rem; color:#cbd5e1; margin-bottom:20px; }
  label { display:block; font-weight:500; margin-bottom:6px; margin-top:12px; }
  input, select {
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1); color:#fff; font-size:1rem; outline:none;
    transition: all 0.3s ease; box-sizing:border-box;
  }
  input:focus, select:focus { border-color:#facc15; box-shadow:0 0 10px #facc15; }
  button#submitBtn {
    display:block; width:100%; padding:14px; margin-top:20px;
    background: linear-gradient(90deg,#facc15,#f59e0b); border:none; border-radius:14px;
    cursor:pointer; font-size:1.1rem; font-weight:bold; transition: transform 0.2s ease, box-shadow 0.3s ease;
  }
  button#submitBtn:hover { transform: translateY(-2px); box-shadow:0 6px 20px rgba(250,204,21,0.5); }
  #loading { display:none; text-align:center; margin-top:12px; font-style:italic; }

  .lang-switch {
    position:absolute; top:15px; right:15px; background:#facc15; color:#000;
    border:none; padding:5px 12px; border-radius:25px; cursor:pointer; font-weight:bold;
    font-size:0.8rem; line-height:1.2; display:flex; align-items:center; gap:5px;
    box-shadow:0 3px 8px rgba(0,0,0,0.3); transition: background 0.3s, transform 0.2s;
  }
  .lang-switch:hover { background:#eab308; transform:scale(1.05); }
  .lang-flag { font-size:1rem; }

  #resultModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                background: rgba(0,0,0,0.75); justify-content:center; align-items:center;
                z-index:999; overflow-y:auto; }
  .modal-content { background: rgba(255,255,255,0.95); color:#000; padding:25px 20px;
                   border-radius:20px; width:90%; max-width:400px; text-align:center;
                   position:relative; box-shadow:0 8px 25px rgba(0,0,0,0.5);
                   animation: fadeIn 0.3s ease-in-out; }
  .modal-content h2 { color:#16a34a; margin-bottom:12px; font-size:1.4rem;
                      font-weight:bold; text-shadow: 0 0 10px rgba(22,163,74,0.5); }
  .modal-content img { max-width:200px; max-height:200px; margin-top:10px; border-radius:10px;
                       box-shadow:0 4px 15px rgba(0,0,0,0.3); }
  .close-btn { position:absolute; top:10px; right:10px; background:#ef4444; color:#fff;
               border:none; border-radius:50%; width:32px; height:32px; cursor:pointer;
               font-weight:bold; }
  .close-btn:hover { background:#dc2626; }
  @keyframes fadeIn { from { opacity:0; transform:scale(0.9);} to { opacity:1; transform:scale(1);} }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
<form class="container" id="registerForm">
  <button type="button" class="lang-switch" onclick="toggleLang()">
    <span id="langFlag" class="lang-flag">üá¨üáß</span>
    <span id="langText">EN</span>
  </button>

  <img src="https://cdn-icons-png.flaticon.com/512/1041/1041883.png" class="logo" alt="Logo">
  <h1 id="formTitle">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πà‡∏á</h1>
  <h2 id="formSubtitle">Running Registration Form</h2>

  <label id="labelFirstName">‡∏ä‡∏∑‡πà‡∏≠</label>
  <input type="text" id="firstName" required>

  <label id="labelLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
  <input type="text" id="lastName" required>

  <label id="labelNationalId">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / Passport</label>
  <input type="text" id="nationalId" required>

  <label id="labelPhone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
  <input type="tel" id="phone" maxlength="10" required>

  <label id="labelEmail">Email</label>
  <input type="email" id="email" required>

  <label id="labelAge">‡∏≠‡∏≤‡∏¢‡∏∏</label>
  <input type="number" id="age" min="1" max="99" required>

  <label id="labelShirtSize">‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠ / Shirt Size</label>
  <select id="shirtSize" required>
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠ --</option>
    <option value="XS">XS 34"</option>
    <option value="S">S 36"</option>
    <option value="M">M 38"</option>
    <option value="L">L 40"</option>
    <option value="XL">XL 42"</option>
    <option value="2XL">2XL 44"</option>
    <option value="3XL">3XL 46"</option>
    <option value="4XL">4XL 48"</option>
  </select>

  <label id="labelCategory">‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏û‡∏®</label>
  <select id="category" required>
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô --</option>
  </select>

  <label id="labelSlip">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
  <input type="file" id="slip" accept="image/*" required>

  <button type="submit" id="submitBtn">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
  <div id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</div>
</form>

<!-- Modal -->
<div id="resultModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()">√ó</button>
    <h2 id="modalTitle">‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ</h2>
    <p id="resultText"></p>
    <img id="slipPreview" src="" alt="slip">
    <br><br>
    <button onclick="closeModal()" style="background:#3b82f6;color:#fff;padding:10px 16px;border-radius:8px;">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://mdbcfmbvqfyqluzgkowu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kYmNmbWJ2cWZ5cWx1emdrb3d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzU2NDksImV4cCI6MjA3NDIxMTY0OX0.5PM8_3ps5brZJLK2oA_VDGbR9dVt-nr-MCo1ZEhuqeA";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let categoriesData = [];

async function loadCategories(){
  const { data, error } = await supabaseClient.from("categories")
    .select("*")
    .eq("is_open",true)
    .order("id",{ascending:true});
  if(!error){
    categoriesData = data;
    renderCategories();
  }
}

function renderCategories(){
  const select = document.getElementById("category");
  select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô --</option>';
  categoriesData.forEach(cat => {
    const opt = document.createElement("option");
    if(currentLang === "TH") {
      opt.value = cat.value;
      opt.textContent = cat.name_th;
      opt.title = cat.name_en;
    } else {
      opt.value = cat.value;
      opt.textContent = cat.name_en;
      opt.title = cat.name_th;
    }
    select.appendChild(opt);
  });
}

document.addEventListener("DOMContentLoaded", loadCategories);

function closeModal(){ document.getElementById("resultModal").style.display="none"; }

let currentLang="TH";
function toggleLang(){
  if(currentLang==="TH"){
    document.getElementById("formTitle").innerText="Running Registration";
    document.getElementById("formSubtitle").innerText="Fill in the form to join the event";
    document.getElementById("labelFirstName").innerText="First Name";
    document.getElementById("labelLastName").innerText="Last Name";
    document.getElementById("labelNationalId").innerText="National ID / Passport";
    document.getElementById("labelPhone").innerText="Phone Number";
    document.getElementById("labelEmail").innerText="Email";
    document.getElementById("labelAge").innerText="Age";
    document.getElementById("labelShirtSize").innerText="Shirt Size";
    document.getElementById("labelCategory").innerText="Category (Age / Gender)";
    document.getElementById("labelSlip").innerText="Upload Payment Slip";
    document.getElementById("submitBtn").innerText="Register";
    document.getElementById("modalTitle").innerText="Registration Completed Successfully! ‚úÖ";
    document.getElementById("langText").innerText="TH";
    document.getElementById("langFlag").innerText="üáπüá≠";
    currentLang="EN";
  } else {
    document.getElementById("formTitle").innerText="‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πà‡∏á";
    document.getElementById("formSubtitle").innerText="Running Registration Form";
    document.getElementById("labelFirstName").innerText="‡∏ä‡∏∑‡πà‡∏≠";
    document.getElementById("labelLastName").innerText="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•";
    document.getElementById("labelNationalId").innerText="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / Passport";
    document.getElementById("labelPhone").innerText="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå";
    document.getElementById("labelEmail").innerText="Email";
    document.getElementById("labelAge").innerText="‡∏≠‡∏≤‡∏¢‡∏∏";
    document.getElementById("labelShirtSize").innerText="‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠";
    document.getElementById("labelCategory").innerText="‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏û‡∏®";
    document.getElementById("labelSlip").innerText="‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô";
    document.getElementById("submitBtn").innerText="‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
    document.getElementById("modalTitle").innerText="‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ";
    document.getElementById("langText").innerText="EN";
    document.getElementById("langFlag").innerText="üá¨üáß";
    currentLang="TH";
  }
  renderCategories();
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ï‡∏£/Passport
function isValidNationalIdOrPassport(value) {
  const thaiIdRegex = /^\d{13}$/; // ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å
  const passportRegex = /^[A-Za-z0-9]{6,15}$/; // Passport
  return thaiIdRegex.test(value) || passportRegex.test(value);
}

// Submit form
document.getElementById("registerForm").addEventListener("submit", async(e)=>{
  e.preventDefault();
  document.getElementById("loading").style.display="block";

  const firstName = document.getElementById("firstName").value.trim();
  const lastName = document.getElementById("lastName").value.trim();
  const nationalId = document.getElementById("nationalId").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const age = document.getElementById("age").value.trim();
  const shirtSize = document.getElementById("shirtSize").value;
  const category = document.getElementById("category").value;
  const slipFile = document.getElementById("slip").files[0];

  if(!isValidNationalIdOrPassport(nationalId)){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å) ‡∏´‡∏£‡∏∑‡∏≠ Passport (6-15 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)");
    document.getElementById("loading").style.display="none";
    return;
  }

  const { data: existing } = await supabaseClient.from("kaimukandaman")
    .select("national_id").eq("national_id",nationalId);
  if(existing && existing.length>0){
    alert("‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£/Passport ‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚ùå");
    document.getElementById("loading").style.display="none";
    return;
  }

  const fileName = `slip_${Date.now()}_${slipFile.name}`;
  const { error: uploadError } = await supabaseClient.storage.from("slips").upload(fileName, slipFile);
  if(uploadError){
    alert("‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå");
    console.error(uploadError);
    document.getElementById("loading").style.display="none";
    return;
  }
  const slipUrl = `${SUPABASE_URL}/storage/v1/object/public/slips/${fileName}`;

  const { error } = await supabaseClient.from("kaimukandaman").insert([{
    first_name:firstName,last_name:lastName,national_id:nationalId,
    phone,email,age,shirt_size:shirtSize,category,slip_url:slipUrl,status:"pending"
  }]);

  document.getElementById("loading").style.display="none";

  if(error){
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå");
    console.error(error);
    return;
  }

  document.getElementById("resultText").innerText=
    `‡∏ä‡∏∑‡πà‡∏≠: ${firstName} ${lastName}\n‡∏≠‡∏≤‡∏¢‡∏∏: ${age}\n‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠: ${shirtSize}\n‡∏£‡∏∏‡πà‡∏ô: ${category}\n‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${phone}\nEmail: ${email}`;
  document.getElementById("slipPreview").src = slipUrl;
  document.getElementById("resultModal").style.display="flex";

  document.getElementById("registerForm").reset();
});
</script>
</body>
</html>
