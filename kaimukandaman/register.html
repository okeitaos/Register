<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ลงทะเบียนวิ่ง</title>
  <style>
    body { font-family: Arial, sans-serif; background:#000; color:#fff; padding:20px; }
    h1 { text-align:center; color:#60a5fa; }
    form { max-width:500px; margin:auto; background:#111; padding:20px; border-radius:10px; }
    label { display:block; margin:10px 0 5px; }
    input, select { width:100%; padding:10px; margin-bottom:15px; border-radius:6px; border:1px solid #333; }
    button { background:#2563eb; color:#fff; border:none; padding:12px; border-radius:6px; cursor:pointer; width:100%; }
    button:hover { background:#1d4ed8; }
    #loading { display:none; text-align:center; margin-top:10px; }
    #resultModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
    .modal-content { background:#fff; color:#000; padding:20px; border-radius:10px; max-width:500px; text-align:center; }
    .modal-content img { max-width:100%; margin-top:10px; border-radius:10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <h1>ลงทะเบียนวิ่ง</h1>

  <form id="registerForm">
    <label>ชื่อ</label>
    <input type="text" id="firstName" required>

    <label>นามสกุล</label>
    <input type="text" id="lastName" required>

    <label>เลขบัตรประชาชน</label>
    <input type="text" id="citizenId" required>

    <label>เบอร์โทรศัพท์</label>
    <input type="tel" id="phone" required>

    <label>Email</label>
    <input type="email" id="email" required>

    <label>รุ่นอายุ/เพศ</label>
    <select id="category" required>
      <option value="">-- เลือกรุ่นการแข่งขัน --</option>
    </select>

    <label>แนบสลิปโอนเงิน</label>
    <input type="file" id="slip" accept="image/*" required>

    <button type="submit">ลงทะเบียน</button>
    <div id="loading">⏳ กำลังบันทึก...</div>
  </form>

  <!-- Modal -->
  <div id="resultModal">
    <div class="modal-content">
      <h2>ลงทะเบียนสำเร็จ ✅</h2>
      <p id="resultText"></p>
      <img id="slipPreview" src="" alt="slip">
      <br><br>
      <button onclick="closeModal()">ปิด</button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://mdbcfmbvqfyqluzgkowu.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kYmNmbWJ2cWZ5cWx1emdrb3d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzU2NDksImV4cCI6MjA3NDIxMTY0OX0.5PM8_3ps5brZJLK2oA_VDGbR9dVt-nr-MCo1ZEhuqeA";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // โหลด categories จาก DB
    async function loadCategories() {
      const { data, error } = await supabaseClient.from("categories").select("*").order("id", { ascending: true });
      if (error) {
        console.error("โหลด categories ไม่ได้:", error);
        return;
      }
      const select = document.getElementById("category");
      data.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat.name;
        opt.textContent = cat.name;
        select.appendChild(opt);
      });
    }
    document.addEventListener("DOMContentLoaded", loadCategories);

    // ปิด modal
    function closeModal() {
      document.getElementById("resultModal").style.display = "none";
    }

    // submit form
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      document.getElementById("loading").style.display = "block";

      const firstName = document.getElementById("firstName").value;
      const lastName = document.getElementById("lastName").value;
      const citizenId = document.getElementById("citizenId").value;
      const phone = document.getElementById("phone").value;
      const email = document.getElementById("email").value;
      const category = document.getElementById("category").value;
      const slipFile = document.getElementById("slip").files[0];

      // ตรวจสอบบัตรประชาชนซ้ำ
      const { data: existing, error: checkError } = await supabaseClient
        .from("kaimukandaman")
        .select("citizen_id")
        .eq("citizen_id", citizenId);

      if (existing && existing.length > 0) {
        alert("เลขบัตรประชาชนนี้ลงทะเบียนแล้ว ❌");
        document.getElementById("loading").style.display = "none";
        return;
      }

      // upload slip
      const fileName = `slip_${Date.now()}_${slipFile.name}`;
      const { data: uploadData, error: uploadError } = await supabaseClient.storage
        .from("slips")
        .upload(fileName, slipFile);

      if (uploadError) {
        alert("อัพโหลดสลิปไม่สำเร็จ ❌");
        console.error(uploadError);
        document.getElementById("loading").style.display = "none";
        return;
      }

      const slipUrl = `${SUPABASE_URL}/storage/v1/object/public/slips/${fileName}`;

      // insert ข้อมูล
      const { data, error } = await supabaseClient.from("kaimukandaman").insert([
        {
          first_name: firstName,
          last_name: lastName,
          citizen_id: citizenId,
          phone: phone,
          email: email,
          category: category,
          slip_url: slipUrl,
          status: "pending"
        }
      ]);

      document.getElementById("loading").style.display = "none";

      if (error) {
        alert("บันทึกไม่สำเร็จ ❌");
        console.error(error);
        return;
      }

      // โชว์ modal
      document.getElementById("resultText").innerText =
        `ชื่อ: ${firstName} ${lastName}\nรุ่น: ${category}\nเบอร์: ${phone}\nEmail: ${email}`;
      document.getElementById("slipPreview").src = slipUrl;
      document.getElementById("resultModal").style.display = "flex";

      document.getElementById("registerForm").reset();
    });
  </script>
</body>
</html>
