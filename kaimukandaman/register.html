<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ลงทะเบียนวิ่ง | Running Registration</title>
  <style>
    /* ---------- Background Gradient ---------- */
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a); 
      color:#fff; 
      margin:0; 
      padding:20px; 
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    /* ---------- Container ---------- */
    .container {
      width:100%; 
      max-width:550px; 
      background: rgba(255,255,255,0.05); 
      border-radius:20px; 
      padding:30px; 
      backdrop-filter: blur(15px); 
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.1);
      text-align:center;
    }

    /* ---------- Logo / Header ---------- */
    .logo {
      width:90px;
      height:90px;
      object-fit:contain;
      margin-bottom:10px;
    }
    h1 { 
      color:#facc15; 
      font-size:1.8rem; 
      margin:0;
      text-shadow: 0 0 15px rgba(250, 204, 21, 0.7);
    }
    h2 { 
      color:#9ca3af; 
      font-size:1rem; 
      font-weight:normal;
      margin-bottom:20px;
    }

    /* ---------- Form ---------- */
    form { text-align:left; }

    label { 
      display:block; 
      margin:10px 0 5px; 
      font-weight:500; 
    }

    input, select { 
      width:100%; 
      padding:12px; 
      margin-bottom:15px; 
      border-radius:10px; 
      border:1px solid rgba(255,255,255,0.2); 
      background: rgba(255,255,255,0.1); 
      color:#fff; 
      outline:none; 
      font-size:1rem;
      transition: all 0.3s ease;
    }
    input:focus, select:focus { 
      border-color:#facc15; 
      box-shadow: 0 0 8px #facc15; 
    }

    button { 
      background: linear-gradient(90deg,#facc15,#f59e0b); 
      color:#000; 
      border:none; 
      padding:14px; 
      border-radius:12px; 
      cursor:pointer; 
      width:100%; 
      font-weight:bold; 
      font-size:1.1rem;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 6px 20px rgba(250,204,21,0.5); 
    }

    #loading { 
      display:none; 
      text-align:center; 
      margin-top:10px; 
      font-style:italic; 
    }

    /* ---------- Modal ---------- */
    #resultModal { 
      display:none; 
      position:fixed; 
      top:0; left:0; 
      width:100%; height:100%; 
      background:rgba(0,0,0,0.7); 
      justify-content:center; 
      align-items:center; 
      z-index:999;
      overflow-y:auto;
    }

    .modal-content { 
      background: rgba(255,255,255,0.95); 
      color:#000; 
      padding:20px; 
      border-radius:16px; 
      width:90%; 
      max-width:380px; 
      text-align:center; 
      position:relative; 
      box-shadow:0 6px 25px rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease-in-out;
    }

    .modal-content h2 { 
      color:#16a34a; 
      margin-bottom:10px; 
    }

    .modal-content img { 
      max-width:220px; 
      max-height:220px; 
      margin-top:10px; 
      border-radius:10px; 
      box-shadow:0 4px 15px rgba(0,0,0,0.4);
    }

    .close-btn {
      position:absolute; 
      top:10px; 
      right:10px; 
      background:#ef4444; 
      color:#fff; 
      border:none; 
      border-radius:50%; 
      width:30px; 
      height:30px; 
      cursor:pointer; 
      font-weight:bold;
      transition: background 0.2s ease;
    }
    .close-btn:hover { background:#dc2626; }

    @keyframes fadeIn {
      from { opacity:0; transform:scale(0.9); }
      to { opacity:1; transform:scale(1); }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- โลโก้ -->
    <img src="https://cdn-icons-png.flaticon.com/512/1041/1041883.png" alt="Logo" class="logo">
    <h1>ลงทะเบียนวิ่ง</h1>
    <h2>Running Registration Form</h2>

    <form id="registerForm">
      <label>ชื่อ (First Name)</label>
      <input type="text" id="firstName" required>

      <label>นามสกุล (Last Name)</label>
      <input type="text" id="lastName" required>

      <label>เลขบัตรประชาชน (National ID)</label>
      <input type="text" id="nationalId" required>

      <label>เบอร์โทรศัพท์ (Phone)</label>
      <input type="tel" id="phone" required>

      <label>อีเมล (Email)</label>
      <input type="email" id="email" required>

      <label>รุ่นอายุ/เพศ (Category)</label>
      <select id="category" required>
        <option value="">-- เลือกรุ่นการแข่งขัน | Select Category --</option>
      </select>

      <label>แนบสลิปโอนเงิน (Upload Payment Slip)</label>
      <input type="file" id="slip" accept="image/*" required>

      <button type="submit">ลงทะเบียน | Register</button>
      <div id="loading">⏳ กำลังบันทึก / Saving...</div>
    </form>
  </div>

  <!-- Modal -->
  <div id="resultModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">×</button>
      <h2>ลงทะเบียนสำเร็จ ✅<br>Registration Successful</h2>
      <p id="resultText"></p>
      <img id="slipPreview" src="" alt="slip">
      <br><br>
      <button onclick="closeModal()" style="background:#3b82f6;color:#fff;">ปิด / Close</button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://mdbcfmbvqfyqluzgkowu.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kYmNmbWJ2cWZ5cWx1emdrb3d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzU2NDksImV4cCI6MjA3NDIxMTY0OX0.5PM8_3ps5brZJLK2oA_VDGbR9dVt-nr-MCo1ZEhuqeA";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // โหลด categories จากฐานข้อมูล
    async function loadCategories() {
      const { data, error } = await supabaseClient.from("categories").select("*").order("id", { ascending: true });
      if (error) {
        console.error("โหลด categories ไม่ได้:", error);
        return;
      }
      const select = document.getElementById("category");
      data.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat.name;
        opt.textContent = cat.name;
        select.appendChild(opt);
      });
    }
    document.addEventListener("DOMContentLoaded", loadCategories);

    // ปิด modal
    function closeModal() {
      document.getElementById("resultModal").style.display = "none";
    }
    document.getElementById("resultModal").addEventListener("click", (e) => {
      if (e.target.id === "resultModal") closeModal();
    });

    // submit form
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      document.getElementById("loading").style.display = "block";

      const firstName = document.getElementById("firstName").value;
      const lastName = document.getElementById("lastName").value;
      const nationalId = document.getElementById("nationalId").value;
      const phone = document.getElementById("phone").value;
      const email = document.getElementById("email").value;
      const category = document.getElementById("category").value;
      const slipFile = document.getElementById("slip").files[0];

      // ตรวจสอบเลขบัตรซ้ำ
      const { data: existing } = await supabaseClient
        .from("kaimukandaman")
        .select("national_id")
        .eq("national_id", nationalId);

      if (existing && existing.length > 0) {
        alert("เลขบัตรประชาชนนี้ลงทะเบียนแล้ว ❌ / This National ID is already registered");
        document.getElementById("loading").style.display = "none";
        return;
      }

      // upload slip
      const fileName = `slip_${Date.now()}_${slipFile.name}`;
      const { error: uploadError } = await supabaseClient.storage
        .from("slips")
        .upload(fileName, slipFile);

      if (uploadError) {
        alert("อัพโหลดสลิปไม่สำเร็จ ❌ / Failed to upload slip");
        console.error(uploadError);
        document.getElementById("loading").style.display = "none";
        return;
      }

      const slipUrl = `${SUPABASE_URL}/storage/v1/object/public/slips/${fileName}`;

      // insert ข้อมูล
      const { error } = await supabaseClient.from("kaimukandaman").insert([
        {
          first_name: firstName,
          last_name: lastName,
          national_id: nationalId,
          phone: phone,
          email: email,
          category: category,
          slip_url: slipUrl,
          status: "pending"
        }
      ]);

      document.getElementById("loading").style.display = "none";

      if (error) {
        alert("บันทึกไม่สำเร็จ ❌ / Failed to save data");
        console.error(error);
        return;
      }

      // โชว์ modal
      document.getElementById("resultText").innerText =
        `ชื่อ / Name: ${firstName} ${lastName}\nรุ่น / Category: ${category}\nเบอร์ / Phone: ${phone}\nอีเมล / Email: ${email}`;
      document.getElementById("slipPreview").src = slipUrl;
      document.getElementById("resultModal").style.display = "flex";

      document.getElementById("registerForm").reset();
    });
  </script>
</body>
</html>
