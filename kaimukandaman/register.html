<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πà‡∏á</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a); 
      color:#fff; 
      margin:0; 
      padding:20px; 
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    h1 { 
      text-align:center; 
      color:#facc15; 
      margin-bottom:10px; 
      font-size:2rem;
      text-shadow: 0 0 15px rgba(250, 204, 21, 0.7);
    }
    h2 { 
      text-align:center;
      margin-bottom:20px;
      font-size:1rem;
      font-weight:normal;
      color:#cbd5e1;
    }
    form { 
      position: relative;
      width:100%; 
      max-width:500px; 
      background: rgba(255,255,255,0.05); 
      border-radius:20px; 
      padding:30px; 
      backdrop-filter: blur(15px); 
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.1);
    }
    label { 
      display:block; 
      margin:10px 0 5px; 
      font-weight:500; 
    }
    input, select { 
      width:100%; 
      padding:12px; 
      margin-bottom:15px; 
      border-radius:10px; 
      border:1px solid rgba(255,255,255,0.2); 
      background: rgba(255,255,255,0.1); 
      color:#fff; 
      outline:none; 
      font-size:1rem;
      transition: all 0.3s ease;
    }
    input:focus, select:focus { 
      border-color:#facc15; 
      box-shadow: 0 0 8px #facc15; 
    }
    button { 
      background: linear-gradient(90deg,#facc15,#f59e0b); 
      color:#000; 
      border:none; 
      padding:14px; 
      border-radius:12px; 
      cursor:pointer; 
      width:100%; 
      font-weight:bold; 
      font-size:1.1rem;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 6px 20px rgba(250,204,21,0.5); 
    }
    #loading { 
      display:none; 
      text-align:center; 
      margin-top:10px; 
      font-style:italic; 
    }
    /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤ */
    .lang-switch {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #facc15;
      color: #000;
      border: none;
      padding: 4px 10px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.75rem;
      line-height: 1.2;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.3s, transform 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .lang-switch:hover {
      background: #eab308;
      transform: scale(1.05);
    }
    .lang-flag { font-size: 1rem; }

    /* Modal */
    #resultModal { 
      display:none; 
      position:fixed; 
      top:0; left:0; 
      width:100%; height:100%; 
      background:rgba(0,0,0,0.7); 
      justify-content:center; 
      align-items:center; 
      z-index:999;
      overflow-y:auto;
    }
    .modal-content { 
      background: rgba(255,255,255,0.95); 
      color:#000; 
      padding:20px; 
      border-radius:16px; 
      width:90%; 
      max-width:400px; 
      text-align:center; 
      position:relative; 
      box-shadow:0 6px 25px rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease-in-out;
    }
    .modal-content h2 { 
      color:#16a34a; 
      margin-bottom:10px; 
    }
    .modal-content img { 
      max-width:200px; 
      max-height:200px; 
      margin-top:10px; 
      border-radius:10px; 
      box-shadow:0 4px 15px rgba(0,0,0,0.4);
    }
    .close-btn {
      position:absolute; 
      top:10px; 
      right:10px; 
      background:#ef4444; 
      color:#fff; 
      border:none; 
      border-radius:50%; 
      width:32px; 
      height:32px; 
      cursor:pointer; 
      font-weight:bold;
    }
    .close-btn:hover { background:#dc2626; }
    @keyframes fadeIn {
      from { opacity:0; transform:scale(0.9); }
      to { opacity:1; transform:scale(1); }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <form id="registerForm">
    <button type="button" class="lang-switch" onclick="toggleLang()">
      <span id="langFlag" class="lang-flag">üá¨üáß</span>
      <span id="langText">EN</span>
    </button>

    <h1 id="formTitle">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πà‡∏á</h1>
    <h2 id="formSubtitle">Running Registration Form</h2>

    <label id="labelFirstName">‡∏ä‡∏∑‡πà‡∏≠</label>
    <input type="text" id="firstName" required>

    <label id="labelLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
    <input type="text" id="lastName" required>

    <label id="labelNationalId">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
    <input type="text" id="nationalId" required>

    <label id="labelPhone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
    <input type="tel" id="phone" required>

    <label id="labelEmail">Email</label>
    <input type="email" id="email" required>

    <label id="labelCategory">‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏û‡∏®</label>
    <select id="category" required>
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô --</option>
    </select>

    <label id="labelSlip">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
    <input type="file" id="slip" accept="image/*" required>

    <button type="submit" id="submitBtn">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    <div id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</div>
  </form>

  <!-- Modal -->
  <div id="resultModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">√ó</button>
      <h2 id="modalTitle">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ</h2>
      <p id="resultText"></p>
      <img id="slipPreview" src="" alt="slip">
      <br><br>
      <button onclick="closeModal()" style="background:#3b82f6;color:#fff;padding:10px 16px;border-radius:8px;">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://mdbcfmbvqfyqluzgkowu.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kYmNmbWJ2cWZ5cWx1emdrb3d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzU2NDksImV4cCI6MjA3NDIxMTY0OX0.5PM8_3ps5brZJLK2oA_VDGbR9dVt-nr-MCo1ZEhuqeA";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ‡πÇ‡∏´‡∏•‡∏î categories
    async function loadCategories() {
      const { data, error } = await supabaseClient.from("categories").select("*").order("id", { ascending: true });
      if (!error) {
        const select = document.getElementById("category");
        data.forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat.name;
          opt.textContent = cat.name;
          select.appendChild(opt);
        });
      }
    }
    document.addEventListener("DOMContentLoaded", loadCategories);

    // ‡∏õ‡∏¥‡∏î modal
    function closeModal() {
      document.getElementById("resultModal").style.display = "none";
    }

    // Toggle Language
    let currentLang = "TH";
    function toggleLang() {
      if (currentLang === "TH") {
        document.getElementById("formTitle").innerText = "Running Registration";
        document.getElementById("formSubtitle").innerText = "Fill in the form to join the event";
        document.getElementById("labelFirstName").innerText = "First Name";
        document.getElementById("labelLastName").innerText = "Last Name";
        document.getElementById("labelNationalId").innerText = "National ID";
        document.getElementById("labelPhone").innerText = "Phone Number";
        document.getElementById("labelEmail").innerText = "Email";
        document.getElementById("labelCategory").innerText = "Category (Age / Gender)";
        document.getElementById("labelSlip").innerText = "Upload Payment Slip";
        document.getElementById("submitBtn").innerText = "Register";
        document.getElementById("modalTitle").innerText = "Registration Successful ‚úÖ";
        document.getElementById("langText").innerText = "TH";
        document.getElementById("langFlag").innerText = "üáπüá≠";
        currentLang = "EN";
      } else {
        document.getElementById("formTitle").innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πà‡∏á";
        document.getElementById("formSubtitle").innerText = "Running Registration Form";
        document.getElementById("labelFirstName").innerText = "‡∏ä‡∏∑‡πà‡∏≠";
        document.getElementById("labelLastName").innerText = "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•";
        document.getElementById("labelNationalId").innerText = "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô";
        document.getElementById("labelPhone").innerText = "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå";
        document.getElementById("labelEmail").innerText = "Email";
        document.getElementById("labelCategory").innerText = "‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏û‡∏®";
        document.getElementById("labelSlip").innerText = "‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô";
        document.getElementById("submitBtn").innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
        document.getElementById("modalTitle").innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ";
        document.getElementById("langText").innerText = "EN";
        document.getElementById("langFlag").innerText = "üá¨üáß";
        currentLang = "TH";
      }
    }

    // submit form
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      document.getElementById("loading").style.display = "block";

      const firstName = document.getElementById("firstName").value;
      const lastName = document.getElementById("lastName").value;
      const nationalId = document.getElementById("nationalId").value;
      const phone = document.getElementById("phone").value;
      const email = document.getElementById("email").value;
      const category = document.getElementById("category").value;
      const slipFile = document.getElementById("slip").files[0];

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏ã‡πâ‡∏≥
      const { data: existing } = await supabaseClient
        .from("kaimukandaman")
        .select("national_id")
        .eq("national_id", nationalId);

      if (existing && existing.length > 0) {
        alert("‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚ùå");
        document.getElementById("loading").style.display = "none";
        return;
      }

      // upload slip
      const fileName = `slip_${Date.now()}_${slipFile.name}`;
      const { error: uploadError } = await supabaseClient.storage
        .from("slips")
        .upload(fileName, slipFile);

      if (uploadError) {
        alert("‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå");
        console.error(uploadError);
        document.getElementById("loading").style.display = "none";
        return;
      }

      const slipUrl = `${SUPABASE_URL}/storage/v1/object/public/slips/${fileName}`;

      // insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      const { error } = await supabaseClient.from("kaimukandaman").insert([
        {
          first_name: firstName,
          last_name: lastName,
          national_id: nationalId,
          phone: phone,
          email: email,
          category: category,
          slip_url: slipUrl,
          status: "pending"
        }
      ]);

      document.getElementById("loading").style.display = "none";

      if (error) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå");
        console.error(error);
        return;
      }

      // ‡πÇ‡∏ä‡∏ß‡πå modal
      document.getElementById("resultText").innerText =
        `‡∏ä‡∏∑‡πà‡∏≠: ${firstName} ${lastName}\n‡∏£‡∏∏‡πà‡∏ô: ${category}\n‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${phone}\nEmail: ${email}`;
      document.getElementById("slipPreview").src = slipUrl;
      document.getElementById("resultModal").style.display = "flex";

      document.getElementById("registerForm").reset();
    });
  </script>
</body>
</html>
