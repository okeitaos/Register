<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πà‡∏á | Running Registration</title>
<style>
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a); 
    color:#fff; margin:0; padding:20px; min-height:100vh;
    display:flex; justify-content:center; align-items:center;
  }
  form.container {
    position: relative; width:100%; max-width:540px;
    background: rgba(255,255,255,0.05); border-radius:20px; padding:28px;
    backdrop-filter: blur(12px); box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    border:1px solid rgba(255,255,255,0.08); text-align:left;
  }
  .logo { display:block; margin:0 auto 12px auto; width:66px; height:66px; }
  h1 { text-align:center; font-size:1.6rem; color:#facc15; margin-bottom:4px;}
  h2 { text-align:center; font-size:0.95rem; color:#cbd5e1; margin-bottom:14px; }
  label { display:block; font-weight:600; margin-bottom:6px; margin-top:12px; font-size:0.95rem; }
  .row { display:flex; gap:10px; align-items:center; }
  input, select {
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06); color:#fff; font-size:0.96rem; outline:none;
    transition: all 0.18s ease; box-sizing:border-box;
  }
  input:focus, select:focus { border-color:#facc15; box-shadow:0 3px 12px rgba(250,204,21,0.12); }
  .small { width:130px; }
  .inline { display:flex; gap:8px; }
  .hint { font-size:0.85rem; color:#ffd; margin-top:6px; }
  .error { font-size:0.85rem; color:#ff7b7b; margin-top:6px; white-space:pre-line; }
  button#submitBtn {
    display:block; width:100%; padding:12px; margin-top:18px;
    background: linear-gradient(90deg,#facc15,#f59e0b); border:none; border-radius:12px;
    cursor:pointer; font-size:1rem; font-weight:700; color:#111;
  }
  button#submitBtn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
  #loading { display:none; text-align:center; margin-top:8px; font-style:italic; color:#cbd5e1; }

  .lang-switch {
    position:absolute; top:12px; right:12px; background:#facc15; color:#000;
    border:none; padding:6px 12px; border-radius:20px; cursor:pointer; font-weight:700;
    font-size:0.85rem; display:flex; align-items:center; gap:6px;
  }
  .lang-switch:hover { transform:scale(1.02); }

  #resultModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:999; }
  .modal-content { background:#fff; color:#000; padding:20px; border-radius:14px; width:92%; max-width:420px; text-align:center; }
  .close-btn { position:absolute; top:8px; right:8px; background:#ef4444; color:#fff; border:none; border-radius:50%; width:34px; height:34px; cursor:pointer; font-weight:bold; }
  .close-btn:hover { background:#dc2626; }

  @media (max-width:520px){
    form.container { padding:18px; }
    .small { width:110px; }
  }

  
  input, select {
    width:100%;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.08);
    color:#fff;
    font-size:0.95rem;
    outline:none;
    transition: all 0.2s ease;
    box-sizing:border-box;
  }
  input:focus, select:focus {
    border-color:#facc15;
    background: rgba(255,255,255,0.12);
    box-shadow:0 0 0 3px rgba(250,204,21,0.25);
  }
  label {
    font-weight:600;
    margin-bottom:6px;
    display:block;
    font-size:0.92rem;
    color:#fefefe;
  }

  /* ‡∏à‡∏±‡∏î layout document type + id ‡πÉ‡∏´‡πâ align ‡∏Å‡∏±‡∏ô */
  .doc-row {
    display:flex;
    gap:12px;
    margin-top:14px;
  }
  .doc-row > div {
    flex:1;
    display:flex;
    flex-direction:column;
  }
  #idHint {
    font-size:0.8rem;
    color:#e0e0a0;
    margin-top:4px;
  }
  #idError {
    font-size:0.8rem;
    color:#ff6b6b;
    margin-top:4px;
  }


</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>

<form class="container" id="registerForm" novalidate>
  <button type="button" class="lang-switch" id="langToggleBtn" onclick="toggleLang()">
    <span id="langFlag">üáπüá≠</span> <span id="langText">TH</span>
  </button>

  <img src="https://cdn-icons-png.flaticon.com/512/1041/1041883.png" class="logo" alt="Logo">
  <h1 id="formTitle">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πà‡∏á</h1>
  <h2 id="formSubtitle">Running Registration Form</h2>

  <label id="labelFirstName">‡∏ä‡∏∑‡πà‡∏≠</label>
  <input type="text" id="firstName" required>

  <label id="labelLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
  <input type="text" id="lastName" required>

  <!-- ID type + input -->
  <div class="doc-row">
  <div>
    <label id="labelIdType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
    <select id="idType">
      <option value="auto">Auto-detect</option>
      <option value="thaiid">‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</option>
      <option value="passport">Passport</option>
    </select>
  </div>
  <div>
    <label id="labelNationalId">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / Passport</label>
    <input type="text" id="nationalId" autocomplete="off" inputmode="text"/>
    <div id="idHint" class="hint"></div>
    <div id="idError" class="error" style="display:none"></div>
  </div>
</div>

  <label id="labelPhone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
  <input type="tel" id="phone" maxlength="10" required>

  <label id="labelEmail">Email</label>
  <input type="email" id="email" required>

  <label id="labelAge">‡∏≠‡∏≤‡∏¢‡∏∏</label>
  <input type="number" id="age" min="1" max="99" required>

  <label id="labelShirtSize">‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠ / Shirt Size</label>
  <select id="shirtSize" required>
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠ --</option>
    <option value="XS">XS 34"</option>
    <option value="S">S 36"</option>
    <option value="M">M 38"</option>
    <option value="L">L 40"</option>
    <option value="XL">XL 42"</option>
    <option value="2XL">2XL 44"</option>
    <option value="3XL">3XL 46"</option>
    <option value="4XL">4XL 48"</option>
  </select>

  <label id="labelCategory">‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏û‡∏®</label>
  <select id="category" required>
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô --</option>
  </select>

  <label id="labelSlip">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
  <input type="file" id="slip" accept="image/*" required>

  <button type="submit" id="submitBtn">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
  <div id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</div>
</form>

<!-- Result Modal -->
<div id="resultModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()">√ó</button>
    <h2 id="modalTitle">‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ</h2>
    <p id="resultText" style="white-space:pre-line; text-align:left;"></p>
    <img id="slipPreview" src="" alt="slip" style="max-width:220px; border-radius:8px; margin-top:8px;">
    <div style="margin-top:12px;"><button onclick="closeModal()" style="background:#3b82f6;color:#fff;padding:8px 14px;border-radius:8px;border:none;">‡∏õ‡∏¥‡∏î</button></div>
  </div>
</div>

<script>
/* ====== Supabase config - ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå) ====== */
const SUPABASE_URL = "https://mdbcfmbvqfyqluzgkowu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kYmNmbWJ2cWZ5cWx1emdrb3d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzU2NDksImV4cCI6MjA3NDIxMTY0OX0.5PM8_3ps5brZJLK2oA_VDGbR9dVt-nr-MCo1ZEhuqeA";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== State ====== */
let categoriesData = [];
let currentLang = "TH"; // TH or EN

/* ====== Utility: Thai ID checksum ====== */
function isValidThaiId(id){
  if(!/^\d{13}$/.test(id)) return false;
  let sum = 0;
  for(let i=0;i<12;i++){
    sum += parseInt(id.charAt(i),10) * (13 - i);
  }
  const check = (11 - (sum % 11)) % 10;
  return check === parseInt(id.charAt(12),10);
}
function isPassportFormat(val){
  // passport: allow alphanumeric 6-15, must include at least one letter
  return /^(?=.*[A-Za-z])[A-Za-z0-9]{6,15}$/.test(val);
}

/* detect type by value */
function detectIdTypeByValue(val){
  if(isValidThaiId(val)) return "thaiid";
  if(isPassportFormat(val)) return "passport";
  return null;
}

/* ====== Language / Texts ====== */
const TEXT = {
  TH: {
    formTitle: "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πà‡∏á",
    formSubtitle: "Running Registration Form",
    labelFirstName: "‡∏ä‡∏∑‡πà‡∏≠",
    labelLastName: "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
    labelIdType: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£",
    labelNationalId: "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / Passport",
    idHintThai: "‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å",
    idHintPassport: "Passport: ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 6‚Äì15 ‡∏ï‡∏±‡∏ß (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß)",
    idErrorThai: "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
    idErrorPassport: "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Passport ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (6‚Äì15 ‡∏ï‡∏±‡∏ß ‡∏≠‡∏±‡∏Å‡∏©‡∏£/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)",
    idErrorGeneric: "‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
    labelPhone: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå",
    labelEmail: "Email",
    labelAge: "‡∏≠‡∏≤‡∏¢‡∏∏",
    labelShirtSize: "‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠",
    labelCategory: "‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏û‡∏®",
    labelSlip: "‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô",
    submitBtn: "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",
    modalTitle: "‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ",
    duplicateMsg: "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£/Passport ‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚ùå",
    uploadError: "‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå",
    saveError: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå",
    fillFields: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"
  },
  EN: {
    formTitle: "Running Registration",
    formSubtitle: "Fill in the form to join the event",
    labelFirstName: "First Name",
    labelLastName: "Last Name",
    labelIdType: "Document Type",
    labelNationalId: "National ID / Passport",
    idHintThai: "Thai ID: 13 digits",
    idHintPassport: "Passport: 6‚Äì15 alphanumeric (must include a letter)",
    idErrorThai: "‚ùå Please enter a valid 13-digit Thai national ID",
    idErrorPassport: "‚ùå Please enter a valid passport number (6‚Äì15 alphanumeric)",
    idErrorGeneric: "‚ùå Invalid format",
    labelPhone: "Phone Number",
    labelEmail: "Email",
    labelAge: "Age",
    labelShirtSize: "Shirt Size",
    labelCategory: "Category (Age / Gender)",
    labelSlip: "Upload Payment Slip",
    submitBtn: "Register",
    modalTitle: "Registration Completed Successfully! ‚úÖ",
    duplicateMsg: "This National ID / Passport is already registered ‚ùå",
    uploadError: "Upload slip failed ‚ùå",
    saveError: "Save failed ‚ùå",
    fillFields: "Please fill all required fields"
  }
};

function applyLanguageUI(){
  const t = TEXT[currentLang];
  document.getElementById("formTitle").innerText = t.formTitle;
  document.getElementById("formSubtitle").innerText = t.formSubtitle;
  document.getElementById("labelFirstName").innerText = t.labelFirstName;
  document.getElementById("labelLastName").innerText = t.labelLastName;
  document.getElementById("labelIdType").innerText = t.labelIdType;
  document.getElementById("labelNationalId").innerText = t.labelNationalId;
  document.getElementById("labelPhone").innerText = t.labelPhone;
  document.getElementById("labelEmail").innerText = t.labelEmail;
  document.getElementById("labelAge").innerText = t.labelAge;
  document.getElementById("labelShirtSize").innerText = t.labelShirtSize;
  document.getElementById("labelCategory").innerText = t.labelCategory;
  document.getElementById("labelSlip").innerText = t.labelSlip;
  document.getElementById("submitBtn").innerText = t.submitBtn;
  document.getElementById("modalTitle").innerText = t.modalTitle;
  document.getElementById("langText").innerText = currentLang;
  document.getElementById("langFlag").innerText = currentLang === "TH" ? "üáπüá≠" : "üá¨üáß";
  // update category options (renderCategories uses currentLang)
  renderCategories();
  updateIdHint(); // update hint text
}

/* toggle language */
function toggleLang(){
  currentLang = currentLang === "TH" ? "EN" : "TH";
  applyLanguageUI();
}

/* ====== Categories load and rendering ====== */
async function loadCategories(){
  try{
    const { data, error } = await supabaseClient.from("categories")
      .select("*")
      .eq("is_open",true)
      .order("id",{ascending:true});
    if(!error && data){
      categoriesData = data;
      renderCategories();
    }
  }catch(err){
    console.error("loadCategories:", err);
  }
}

function renderCategories(){
  const select = document.getElementById("category");
  const t = TEXT[currentLang];
  select.innerHTML = `<option value="">-- ${t.labelCategory} --</option>`;
  categoriesData.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat.value || cat.id;
    opt.textContent = currentLang === "TH" ? (cat.name_th || cat.name_en) : (cat.name_en || cat.name_th);
    select.appendChild(opt);
  });
}

/* ====== ID validation & UI helpers ====== */
const idTypeSelect = document.getElementById("idType");
const nationalIdInput = document.getElementById("nationalId");
const idHintElem = document.getElementById("idHint");
const idErrorElem = document.getElementById("idError");
const submitBtn = document.getElementById("submitBtn");
const loadingElem = document.getElementById("loading");

function updateIdHint(){
  const t = TEXT[currentLang];
  const selected = idTypeSelect.value;
  if(selected === "thaiid"){
    idHintElem.innerText = t.idHintThai;
  } else if(selected === "passport"){
    idHintElem.innerText = t.idHintPassport;
  } else {
    idHintElem.innerText = t.idHintThai + " / " + t.idHintPassport;
  }
}

function showIdError(msg){
  idErrorElem.style.display = "block";
  idErrorElem.innerText = msg;
  nationalIdInput.style.border = "2px solid #ff7b7b";
  submitBtn.disabled = true;
}
function clearIdError(){
  idErrorElem.style.display = "none";
  idErrorElem.innerText = "";
  nationalIdInput.style.border = "";
  submitBtn.disabled = false;
}

/* real-time validation */
nationalIdInput.addEventListener("input", () => {
  const raw = nationalIdInput.value.trim();
  const sel = idTypeSelect.value;
  const t = TEXT[currentLang];

  if(raw === ""){
    clearIdError();
    updateIdHint();
    return;
  }

  if(sel === "auto"){
    const detected = detectIdTypeByValue(raw);
    if(detected === "thaiid"){
      clearIdError();
      idHintElem.innerText = t.idHintThai;
    } else if(detected === "passport"){
      clearIdError();
      idHintElem.innerText = t.idHintPassport;
    } else {
      showIdError(t.idErrorGeneric);
    }
  } else if(sel === "thaiid"){
    if(!isValidThaiId(raw)){
      showIdError(t.idErrorThai);
    } else clearIdError();
  } else if(sel === "passport"){
    if(!isPassportFormat(raw)){
      showIdError(t.idErrorPassport);
    } else clearIdError();
  }
});

/* when user changes idType select, update hint & validate again */
idTypeSelect.addEventListener("change", () => {
  updateIdHint();
  // trigger validation
  const ev = new Event('input');
  nationalIdInput.dispatchEvent(ev);
});

/* auto-detect: if idType is auto and typed value clearly matches one type, optionally show that */
nationalIdInput.addEventListener("blur", () => {
  if(idTypeSelect.value === "auto"){
    const detected = detectIdTypeByValue(nationalIdInput.value.trim());
    if(detected){
      // do nothing or optionally set placeholder; we keep selection as auto but show hint
      // (we don't force-select, to avoid surprising user)
    }
  }
});

/* ====== Submit handler ====== */
document.getElementById("registerForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  // basic required checks
  const firstName = document.getElementById("firstName").value.trim();
  const lastName = document.getElementById("lastName").value.trim();
  const rawId = nationalIdInput.value.trim();
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const age = document.getElementById("age").value.trim();
  const shirtSize = document.getElementById("shirtSize").value;
  const category = document.getElementById("category").value;
  const slipFile = document.getElementById("slip").files[0];

  const t = TEXT[currentLang];

  if(!firstName || !lastName || !rawId || !phone || !email || !age || !shirtSize || !category || !slipFile){
    alert(t.fillFields);
    return;
  }

  // validate according to selection / auto-detect
  const sel = idTypeSelect.value;
  let isValid = false;
  if(sel === "auto"){
    if(isValidThaiId(rawId) || isPassportFormat(rawId)) isValid = true;
  } else if(sel === "thaiid"){
    if(isValidThaiId(rawId)) isValid = true;
  } else if(sel === "passport"){
    if(isPassportFormat(rawId)) isValid = true;
  }

  if(!isValid){
    alert(t.idErrorGeneric);
    return;
  }

  // disable submit + show loading
  submitBtn.disabled = true;
  loadingElem.style.display = "block";

  try {
    // duplicate check using national_id field (assumes that DB column exists)
    const { data: existing, error: exErr } = await supabaseClient.from("kaimukandaman")
      .select("national_id")
      .eq("national_id", rawId);

    if(exErr){
      console.error("duplicate check error:", exErr);
    }
    if(existing && existing.length > 0){
      alert(t.duplicateMsg);
      submitBtn.disabled = false;
      loadingElem.style.display = "none";
      return;
    }

    // upload slip to storage
    const fileName = `slip_${Date.now()}_${(slipFile.name || "").replace(/\s+/g,'_')}`;
    const { error: uploadError } = await supabaseClient.storage.from("slips").upload(fileName, slipFile);

    if(uploadError){
      console.error("uploadError:", uploadError);
      alert(t.uploadError);
      submitBtn.disabled = false;
      loadingElem.style.display = "none";
      return;
    }

    // build public url (alternative: use supabaseClient.storage.from('slips').getPublicUrl)
    const slipUrl = `${SUPABASE_URL}/storage/v1/object/public/slips/${encodeURIComponent(fileName)}`;

    // insert record
    const { error: insertError } = await supabaseClient.from("kaimukandaman").insert([{
      first_name: firstName,
      last_name: lastName,
      national_id: rawId,
      phone,
      email,
      age,
      shirt_size: shirtSize,
      category,
      slip_url: slipUrl,
      status: "pending"
    }]);

    loadingElem.style.display = "none";
    submitBtn.disabled = false;

    if(insertError){
      console.error("insertError:", insertError);
      alert(t.saveError);
      return;
    }

    // show modal with details
    document.getElementById("resultText").innerText =
      `${TEXT[currentLang].labelFirstName}: ${firstName} ${lastName}\n${TEXT[currentLang].labelAge}: ${age}\n${TEXT[currentLang].labelShirtSize}: ${shirtSize}\n${TEXT[currentLang].labelCategory}: ${category}\n${TEXT[currentLang].labelPhone}: ${phone}\nEmail: ${email}`;
    document.getElementById("slipPreview").src = slipUrl;
    document.getElementById("resultModal").style.display = "flex";

    // reset form
    document.getElementById("registerForm").reset();
    updateIdHint();
  } catch(err){
    console.error("submit error:", err);
    alert(TEXT[currentLang].saveError);
    submitBtn.disabled = false;
    loadingElem.style.display = "none";
  }
});

/* ====== Modal close ====== */
function closeModal(){
  document.getElementById("resultModal").style.display = "none";
}

/* ====== Init ====== */
document.addEventListener("DOMContentLoaded", async () => {
  // set initial language UI
  applyLanguageUI();
  // load categories
  await loadCategories();
  // update hint
  updateIdHint();
});

/* ====== small protections like before (optional) ====== */
document.addEventListener("contextmenu", e => { /* e.preventDefault(); */ }); // keep but not blocking UX
document.addEventListener("keydown", e=>{ 
  if(e.key==="F12" || (e.ctrlKey && e.shiftKey && e.key==="I") || (e.ctrlKey && e.key==="u")){
    e.preventDefault();
  }
});
</script>
</body>
</html>
