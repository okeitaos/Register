<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Approve Registrations</title>
<style>
body {font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:#f4f6f9; margin:0; padding:20px; color:#333;}
h1 {text-align:center; margin-bottom:20px; color:#222;}
table {width:100%; border-collapse:collapse; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
th, td {padding:12px; border:1px solid #ddd; text-align:center;}
th {background:#222; color:#fff;}
img.slip {max-width:80px; border-radius:6px; cursor:pointer;}
button {padding:6px 12px; border:none; border-radius:4px; cursor:pointer; font-size:14px;}
button.approve {background:#28a745; color:white;}
button.approve:hover {background:#218838;}
.modal {display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6);}
.modal-content {background:#fff; margin:5% auto; padding:20px; width:350px; border-radius:8px; text-align:center; position:relative;}
.modal-content img {max-width:100%; max-height:300px; border-radius:8px;}
.close {position:absolute; right:10px; top:5px; font-size:20px; font-weight:bold; color:#333; cursor:pointer;}
</style>
</head>
<body>
<h1>Admin Panel - Approve Registrations</h1>
<table id="participantsTable">
<thead>
<tr>
<th>ID</th>
<th>Full Name</th>
<th>Email</th>
<th>Category</th>
<th>Slip</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="slipModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal()">&times;</span>
<img id="slipImage" src="" alt="Slip Image"/>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
// Config
const SUPABASE_URL = "https://mdbcfmbvqfyqluzgkowu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kYmNmbWJ2cWZ5cWx1emdrb3d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzU2NDksImV4cCI6MjA3NDIxMTY0OX0.5PM8_3ps5brZJLK2oA_VDGbR9dVt-nr-MCo1ZEhuqeA";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// EmailJS Init
emailjs.init("xyPTiaVqlFqMrd_3U"); // Public Key
const EMAILJS_SERVICE_ID = "service_w51dn0v";
const EMAILJS_TEMPLATE_ID = "template_ghijgse";

async function loadParticipants() {
  const { data, error } = await client.from("kaimukandaman").select("*").order("id",{ascending:true});
  const tbody = document.querySelector("#participantsTable tbody");
  if(error){ console.error(error); tbody.innerHTML="<tr><td colspan='7'>Error loading data</td></tr>"; return;}
  if(!data || data.length===0){ tbody.innerHTML="<tr><td colspan='7'>No applicants</td></tr>"; return;}

  tbody.innerHTML="";
  data.forEach(p=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${p.id}</td>
      <td>${p.first_name} ${p.last_name}</td>
      <td>${p.email || "-"}</td>
      <td>${p.category || "-"}</td>
      <td>${p.slip_url ? `<img src="${p.slip_url}" class="slip" onclick="openModal('${p.slip_url}')"/>` : "-"}</td>
      <td>${p.status || "Pending"}</td>
      <td>
        <button class="approve" ${p.status==="Approved"?"disabled":""}>Approve</button>
      </td>
    `;
    tbody.appendChild(tr);

    const btnApprove = tr.querySelector(".approve");
    btnApprove.addEventListener("click",()=>approve(p));
  });
}

async function approve(participant){
  if(!confirm(`Approve ${participant.first_name} ${participant.last_name}?`)) return;

  const { error } = await client.from("kaimukandaman").update({status:"Approved"}).eq("id",participant.id);
  if(error){ alert("Failed to update status!"); console.error(error); return;}

  // ส่ง Email bilingual
  const templateParams = {
    to_email: participant.email,
    to_name: `${participant.first_name} ${participant.last_name}`,
    category: participant.category || "-"
  };

  emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
    .then(res=>{
      console.log("Email sent:", res);
      alert(`Approved & email sent to ${participant.email}`);
      loadParticipants();
    })
    .catch(err=>{
      console.error("Email failed:", err);
      alert(`Approved but email failed to send to ${participant.email}`);
      loadParticipants();
    });
}

// Modal
function openModal(url){ document.getElementById("slipImage").src=url; document.getElementById("slipModal").style.display="block"; }
function closeModal(){ document.getElementById("slipModal").style.display="none"; }

loadParticipants();
</script>
</body>
</html>
