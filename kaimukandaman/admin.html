<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - สมัครวิ่ง</title>
<style>
body { font-family: Arial,sans-serif; background:#000; color:#f3f4f6; padding:20px; }
h1 { text-align:center; color:#60a5fa; margin-bottom:20px; }
table { width:100%; border-collapse: collapse; }
th, td { padding:12px; border:1px solid #4b5563; text-align:center; }
th { background:#1e40af; color:white; }
tr:nth-child(even){ background:#1f2937; }
button { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; color:white; }
.approve { background:#16a34a; }
.reject { background:#dc2626; }
img { max-width:80px; border-radius:6px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
<h1>Admin Dashboard - สมัครวิ่ง</h1>

<table>
<thead>
<tr>
  <th>ลำดับ</th>
  <th>ชื่อ - นามสกุล</th>
  <th>Email</th>
  <th>รุ่น</th>
  <th>สลิป</th>
  <th>สถานะ</th>
  <th>จัดการ</th>
</tr>
</thead>
<tbody id="applicantsBody"></tbody>
</table>

<script>
// ---------------- Supabase ----------------
const SUPABASE_URL = "https://mdbcfmbvqfyqluzgkowu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kYmNmbWJ2cWZ5cWx1emdrb3d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzU2NDksImV4cCI6MjA3NDIxMTY0OX0.5PM8_3ps5brZJLK2oA_VDGbR9dVt-nr-MCo1ZEhuqeA";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ---------------- Resend API ----------------
const RESEND_API_KEY = "re_DhgQeqUt_CeDDhHhyrc8J3H8YLozDKKPW";

// โหลดผู้สมัคร
async function loadApplicants(){
  const { data, error } = await client.from("kaimukandaman").select("*").order("id",{ascending:true});
  if(error){ console.error(error); return; }

  const tbody = document.getElementById("applicantsBody");
  tbody.innerHTML = "";

  data.forEach((app,index)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${index+1}</td>
      <td>${app.first_name} ${app.last_name}</td>
      <td>${app.email}</td>
      <td>${app.category}</td>
      <td><img src="${app.slip_url}" alt="Slip"></td>
      <td>${app.status}</td>
      <td>
        <button class="approve" onclick="updateStatus(${app.id},'approved')">อนุมัติ</button>
        <button class="reject" onclick="updateStatus(${app.id},'rejected')">ปฏิเสธ</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ส่งอีเมลผ่าน Resend API
async function sendApprovalEmail(to_email, fullName, category){
  try {
    await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + RESEND_API_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        from: 'no-reply@yourdomain.com',
        to: [to_email],
        subject: 'ผลการสมัครวิ่ง',
        html: `<p>สวัสดี ${fullName},</p>
               <p>คุณได้รับอนุมัติให้เข้าร่วมการแข่งขันรุ่น: <strong>${category}</strong></p>
               <p>ขอบคุณที่สมัครเข้าร่วมกิจกรรม</p>`
      })
    });
    console.log("ส่งอีเมลสำเร็จ");
  } catch(err){
    console.error("ส่งอีเมลไม่สำเร็จ:", err);
  }
}

// อัปเดตสถานะ
async function updateStatus(id,status){
  const { data: applicant, error: fetchError } = await client.from("kaimukandaman").select("*").eq("id",id).single();
  if(fetchError){ alert("เกิดข้อผิดพลาด: "+fetchError.message); return; }

  const { error } = await client.from("kaimukandaman").update({status}).eq("id",id);
  if(error){ alert("เกิดข้อผิดพลาด: "+error.message); return; }

  if(status === "approved"){
    await sendApprovalEmail(applicant.email, applicant.first_name + " " + applicant.last_name, applicant.category);
  }

  loadApplicants();
}

// โหลดตอนเปิดหน้า
loadApplicants();
</script>
</body>
</html>
